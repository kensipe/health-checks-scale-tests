# Mesos-native health checks testing rig

## Setup
1. Create a DC/OS cluster.
2. Login to the master and grab the JWT token using: ```curl -k -v -X POST https://<master ip>/acs/api/v1/auth/login -d '{"uid": "bootstrapuser", "password": "deleteme"}' -H 'Content-Type: application/json'```
3. Create an app using one of the app definitions included in this document.
4. Don't forget to update the test script with the right token, step (`10` for small clusters, `100` for bigger ones), container type, and health check type.
5. Run the hc scale test script.


## Debugging
### Finding tasks that failed a health check.
Open the JSON files generated by the Python script and look for: `"alive": false`.

### sysdig cheat sheet
Run `sysdig -C 1024 -W 4 -z -w cap.scap.gz` to capture data.

Some interesting filters:

- `proc.apid=<pid of the executor>` will give you the traces of all the children of an executor, once you find its pid.
- `fd.sport=<port of the unstable task>` will give you the traces of the task and the health checker. You can get this port from the `json` output of the Python script.

## Marathon App Definitions

### Mesos Containerizer
If you are running a Debian VM, `ncat` comes with the `nmap` package.

#### Mesos TCP checks
```json
{
  "id": "/hc",
  "cmd": "ncat -l -k -p $PORT",
  "cpus": 0.001,
  "mem": 64,
  "instances": 1,
  "healthChecks": [
    {
      "protocol": "MESOS_TCP",
      "gracePeriodSeconds": 20,
      "intervalSeconds": 1,
      "timeoutSeconds": 5,
      "maxConsecutiveFailures": 3,
      "portIndex": 0,
      "delaySeconds": 0
    }
  ],
  "portDefinitions": [
    {
      "protocol": "tcp",
      "port": 0
    }
  ]
}
```

#### Marathon TCP checks
```json
{
  "id": "/hc",
  "cmd": "ncat -l -k -p $PORT",
  "cpus": 0.001,
  "mem": 64,
  "instances": 1,
  "healthChecks": [
    {
      "protocol": "TCP",
      "gracePeriodSeconds": 20,
      "intervalSeconds": 1,
      "timeoutSeconds": 5,
      "maxConsecutiveFailures": 3,
      "portIndex": 0
    }
  ],
  "portDefinitions": [
    {
      "protocol": "tcp",
      "port": 0
    }
  ]
}
```

### Docker Containerizer

#### Mesos TCP checks
```json
{
  "id": "/hc",
  "cmd": "nc -l -k -p $PORT -e true",
  "cpus": 0.01,
  "mem": 64,
  "instances": 1,
  "container": {
    "docker": {
      "image": "alpine",
      "network": "HOST"
    }
  },
  "healthChecks": [
    {
      "protocol": "MESOS_TCP",
      "gracePeriodSeconds": 20,
      "intervalSeconds": 1,
      "timeoutSeconds": 5,
      "maxConsecutiveFailures": 3,
      "portIndex": 0,
      "delaySeconds": 0
    }
  ],
  "portDefinitions": [
    {
      "protocol": "tcp",
      "port": 0
    }
  ]
}
```

#### Marathon TCP checks
```json
{
  "id": "/hc",
  "cmd": "nc -l -k -p $PORT -e true",
  "cpus": 0.01,
  "mem": 64,
  "instances": 1,
  "container": {
    "docker": {
      "image": "alpine",
      "network": "HOST"
    }
  },
  "healthChecks": [
    {
      "protocol": "TCP",
      "gracePeriodSeconds": 20,
      "intervalSeconds": 1,
      "timeoutSeconds": 5,
      "maxConsecutiveFailures": 3,
      "portIndex": 0
    }
  ],
  "portDefinitions": [
    {
      "protocol": "tcp",
      "port": 0
    }
  ]
}
```

#### Mesos HTTP checks
```json
{
  "id": "/hc",
  "cmd": "python -m SimpleHTTPServer $PORT",
  "cpus": 0.01,
  "mem": 64,
  "instances": 1,
  "container": {
    "docker": {
      "image": "python:2",
      "network": "HOST"
    }
  },
  "healthChecks": [
    {
      "protocol": "MESOS_HTTP",
      "gracePeriodSeconds": 20,
      "intervalSeconds": 1,
      "timeoutSeconds": 5,
      "maxConsecutiveFailures": 3,
      "portIndex": 0,
      "delaySeconds": 0
    }
  ],
  "portDefinitions": [
    {
      "protocol": "tcp",
      "port": 0
    }
  ]
}
```

#### Marathon HTTP checks
```json
{
  "id": "/hc",
  "cmd": "python -m SimpleHTTPServer $PORT",
  "cpus": 0.01,
  "mem": 64,
  "instances": 1,
  "container": {
    "docker": {
      "image": "python:2",
      "network": "HOST"
    }
  },
  "healthChecks": [
    {
      "protocol": "HTTP",
      "gracePeriodSeconds": 20,
      "intervalSeconds": 1,
      "timeoutSeconds": 5,
      "maxConsecutiveFailures": 3,
      "portIndex": 0
    }
  ],
  "portDefinitions": [
    {
      "protocol": "tcp",
      "port": 0
    }
  ]
}
```
